<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AmFam Fit World — Level Quest (LocalStorage)</title>
  <style>
    :root{
      --amfam-red:#e11d2b; --amfam-blue:#0054a6; --ink:#0f172a; --muted:#64748b; --paper:#f8fafc; --card:#ffffff; --track:#e2e8f0; --ring:rgba(0,84,166,.25);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink);background:linear-gradient(180deg,#eef4ff 0,#ffffff 40%)}
    .wrap{max-width:980px;margin:20px auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    h1{margin:0;font-size:clamp(1.3rem,1.1rem+1.5vw,2.1rem);font-weight:900;letter-spacing:.2px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .badge{background:linear-gradient(90deg,var(--amfam-blue),var(--amfam-red));color:#fff;padding:.25rem .6rem;border-radius:999px;font-weight:800;font-size:.85rem}
    .sub{color:var(--muted)}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    button{appearance:none;border:2px solid var(--amfam-blue);background:#fff;color:var(--amfam-blue);padding:.6rem .85rem;border-radius:12px;cursor:pointer;font-weight:800;transition:.15s ease;box-shadow:0 2px 0 var(--amfam-blue)}
    button:hover{transform:translateY(-1px)}
    .btn-primary{background:linear-gradient(135deg,var(--amfam-blue),#3b82f6);color:#fff;border:none;box-shadow:none}
    .btn-reset{background:linear-gradient(135deg,#ef4444,#f97316);color:#fff;border:none;box-shadow:none}

    .board{margin-top:14px;background:var(--paper);border:1px solid var(--track);border-radius:18px;padding:14px;box-shadow:0 12px 40px rgba(2,6,23,.08)}

    /* IMMERSIVE WORLD */
    .world{position:relative; height:460px; overflow:hidden; border-radius:16px; border:1px solid var(--track); background:#cfe6ff}
    .layer{position:absolute; inset:0; image-rendering:crisp-edges; will-change:transform;}
    .sky{background:linear-gradient(180deg,#cfe6ff,#eaf3ff)}
    .bg-hills{background:repeating-linear-gradient( -20deg, #b7d0ff 0 40px, #a7c6ff 40px 80px ); opacity:.6}
    .mid-buildings{background:repeating-linear-gradient( 90deg, #9cc3ff 0 140px, #91b8f7 140px 280px ); clip-path:polygon(0 65%,100% 55%,100% 100%,0 100%)}
    .floor{background:linear-gradient(180deg,#9ee57c,#70d060 60%,#58b64a); clip-path:polygon(0 72%,100% 68%,100% 100%,0 100%)}

    .track{position:absolute; left:0; top:72%; height:4px; width:3000px; background:repeating-linear-gradient(90deg,#084 0 24px,#0a5 24px 48px); box-shadow:0 2px 0 rgba(0,0,0,.15)}
    .gate{position:absolute; top:56%; transform:translateY(-50%); width:200px}
    .gate .card{background:var(--card);border:1px solid var(--track);border-radius:14px;padding:10px 12px;box-shadow:0 6px 18px rgba(2,6,23,.06)}
    .gate h3{margin:0 0 4px 0; font-size:1rem}
    .gate p{margin:0 0 6px 0; font-size:.9rem; color:var(--muted)}
    .gate .meta{display:flex;gap:6px;align-items:center;font-size:.8rem;margin-bottom:6px}
    .pill{border:1px solid var(--track);border-radius:999px;padding:.1rem .45rem;color:#0f172a;background:#f8fafc}
    .gate.locked{filter:grayscale(.8) opacity(.75)}
    .gate.completed .card{outline:2px solid #10b981}

    .avatar{position:absolute; top:72%; left:40px; width:28px; height:28px; border:2px solid #fff; background:linear-gradient(135deg,var(--amfam-red),var(--amfam-blue)); border-radius:50%; box-shadow:0 0 0 3px rgba(0,84,166,.25); transform:translate(-50%,-50%)}

    .hud{position:absolute; inset:auto 12px 12px auto; display:flex; gap:8px}
    .stat{background:#fff;border:1px solid var(--track);padding:.4rem .6rem;border-radius:10px;font-weight:800}

    .stats{display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin:12px 0 4px}
    .progress{--p:0%;position:relative;height:12px;background:#eef2ff;border:1px solid #c7d2fe;border-radius:999px;overflow:hidden;flex:1}
    .progress>i{position:absolute;inset:0;width:var(--p);background:linear-gradient(90deg,var(--amfam-blue),var(--amfam-red))}

    .hint{color:var(--muted);font-size:.9rem}
  </style>
</head>
<body>
  <div class="wrap" role="application" aria-label="AmFam Fit World">
    <header>
      <div class="brand">
        <h1>AmFam Fit World — Level Quest</h1>
        <span class="badge">Virtual Gym</span>
      </div>
      <div class="controls" role="toolbar" aria-label="Controls">
        <button id="btn-submit" class="btn-primary" title="Open prefilled form in a new tab">Submit Progress</button>
        <button id="btn-reset" class="btn-reset" title="Reset local progress">Reset</button>
      </div>
    </header>
    <p class="sub">Progress through a virtual American Family Fitness–inspired world. Complete each level's challenge to unlock the next — no login, saved locally.</p>

    <section class="board">
      <div class="stats" aria-live="polite">
        <div class="stat">Level: <span id="level">1</span>/<span id="levelMax">10</span></div>
        <div class="stat">Completed: <span id="completed">0</span></div>
        <div class="progress" aria-label="Quest completion"><i id="bar"></i></div>
      </div>
      <div class="world" id="world" aria-label="AmFam Fit World">
        <div class="layer sky" data-speed="0.1"></div>
        <div class="layer bg-hills" data-speed="0.2"></div>
        <div class="layer mid-buildings" data-speed="0.35"></div>
        <div class="layer floor" data-speed="0.55"></div>
        <div class="track" id="track"></div>

        <!-- Gates (levels) placed along the track -->
        <div class="gate" style="left:120px" data-i="0">
          <div class="card"><h3>Level 1 — Check In</h3><p>Visit the club or check in on the app.</p><div class="meta"><span class="pill">Facility</span><span class="pill">Warmup</span></div><button class="do">Complete</button></div>
        </div>
        <div class="gate" style="left:420px" data-i="1">
          <div class="card"><h3>Level 2 — Strength</h3><p>Do a basic strength session (20 min).</p><div class="meta"><span class="pill">Weights</span></div><button class="do">Complete</button></div>
        </div>
        <div class="gate" style="left:780px" data-i="2">
          <div class="card"><h3>Level 3 — Cardio</h3><p>Cycle, run, or row for 15 min.</p><div class="meta"><span class="pill">Cardio</span></div><button class="do">Complete</button></div>
        </div>
        <div class="gate" style="left:1160px" data-i="3">
          <div class="card"><h3>Level 4 — Hydrate</h3><p>Drink 2 bottles of water today.</p><div class="meta"><span class="pill">Health</span></div><button class="do">Complete</button></div>
        </div>
        <div class="gate" style="left:1520px" data-i="4">
          <div class="card"><h3>Level 5 — Mobility</h3><p>Stretch or foam roll 10 min.</p><div class="meta"><span class="pill">Recovery</span></div><button class="do">Complete</button></div>
        </div>
        <div class="gate" style="left:1860px" data-i="5">
          <div class="card"><h3>Level 6 — Group Fitness</h3><p>Attend a class (e.g., HIIT, Yoga).</p><div class="meta"><span class="pill">Community</span></div><button class="do">Complete</button></div>
        </div>
        <div class="gate" style="left:2140px" data-i="6">
          <div class="card"><h3>Level 7 — Pool</h3><p>Swim or water-walk 10 lengths.</p><div class="meta"><span class="pill">Aquatics</span></div><button class="do">Complete</button></div>
        </div>
        <div class="gate" style="left:2380px" data-i="7">
          <div class="card"><h3>Level 8 — Virtuagym</h3><p>Complete 1 guided in‑app workout.</p><div class="meta"><span class="pill">App</span></div><button class="do">Complete</button></div>
        </div>
        <div class="gate" style="left:2620px" data-i="8">
          <div class="card"><h3>Level 9 — Fuel</h3><p>Log a balanced meal today.</p><div class="meta"><span class="pill">Nutrition</span></div><button class="do">Complete</button></div>
        </div>
        <div class="gate" style="left:2860px" data-i="9">
          <div class="card"><h3>Level 10 — Finale</h3><p>Share your success photo or check‑in.</p><div class="meta"><span class="pill">Celebrate</span></div><button class="do">Complete</button></div>
        </div>

        <div class="avatar" id="avatar" title="Your marker"></div>
        <div class="hud">
          <div class="stat">Use ◀ ▶ or drag</div>
        </div>
      </div>
      <p class="hint">Immersive mode: side‑scroll through the AmFam world. Complete each gate to unlock the next. All progress is stored in localStorage.</p>>Tip: Levels unlock sequentially. Your progress is saved on this device only (localStorage). “Submit Progress” can prefill a Google Form for the club.</p>
    </section>
  </div>

<script>
// ===== CONFIG
const BOARD_KEY = 'amfam.fitworld.immersive.v1';
const FORM_BASE = 'https://docs.google.com/forms/d/e/FORM_ID/viewform';
const ENTRY_MAP = { level:'entry.100', completed:'entry.101', name:'entry.102' };
const LEVELS = 10; // number of gates

// ===== STATE
const defaultState = ()=>({ idx:0, completed: Array(LEVELS).fill(false), name: localStorage.getItem('fitworld.name') || '', x: 60 });
function load(){ try { return JSON.parse(localStorage.getItem(BOARD_KEY)) ?? defaultState(); } catch { return defaultState(); } }
function save(s){ localStorage.setItem(BOARD_KEY, JSON.stringify(s)); }
let state = load();

// ===== DOM
const $ = (s)=>document.querySelector(s);
const world = $('#world');
const layers = [...document.querySelectorAll('.layer')];
const avatar = $('#avatar');
const gates = [...document.querySelectorAll('.gate')];
const barEl = $('#bar');
const completedEl = $('#completed');
const levelEl = $('#level'); const levelMaxEl = $('#levelMax'); levelMaxEl && (levelMaxEl.textContent = LEVELS);

// HUD stats (reuse from earlier section if present)
if(!levelEl || !completedEl){
  const stats = document.createElement('div'); stats.className='stats'; stats.innerHTML = `<div class="stat">Level: <span id="level">1</span>/${LEVELS}</div><div class="stat">Completed: <span id="completed">0</span></div><div class="progress"><i id="bar"></i></div>`; world.before(stats);
}

// ===== RENDER
function render(){
  // Lock/unlock
  gates.forEach(g=> g.classList.add('locked'));
  for(let i=0;i<=state.idx;i++){ gates[i]?.classList.remove('locked'); }
  gates.forEach((g,i)=> g.classList.toggle('completed', !!state.completed[i]));

  // Buttons
  gates.forEach((g,i)=>{
    const btn = g.querySelector('.do');
    btn.disabled = i>state.idx || state.completed[i];
    btn.textContent = state.completed[i] ? 'Completed' : (i>state.idx ? 'Locked' : 'Complete');
    btn.onclick = ()=> completeLevel(i);
  });

  // Progress
  const done = state.completed.filter(Boolean).length;
  const level = Math.min(done+1, LEVELS);
  (document.getElementById('completed')||{}).textContent = done;
  (document.getElementById('level')||{}).textContent = level;
  (document.getElementById('bar')||{}).style?.setProperty('--p', `${Math.round((done/LEVELS)*100)}%`);

  updateCamera();
}

// ===== MOVEMENT (arrow keys + drag)
let dragging = false, dragStartX = 0, startX = 0;
world.addEventListener('pointerdown', e=>{ dragging=true; dragStartX=e.clientX; startX = state.x; world.setPointerCapture(e.pointerId); });
world.addEventListener('pointermove', e=>{ if(!dragging) return; const dx = e.clientX - dragStartX; state.x = Math.max(0, Math.min(2940, startX + dx)); updateCamera(); });
world.addEventListener('pointerup', ()=> dragging=false);
world.addEventListener('pointercancel', ()=> dragging=false);

window.addEventListener('keydown', e=>{
  if(e.key==='ArrowRight') { state.x = Math.min(2940, state.x + 24); updateCamera(); }
  if(e.key==='ArrowLeft')  { state.x = Math.max(0, state.x - 24); updateCamera(); }
});

function updateCamera(){
  // Parallax: move layers at different speeds opposite to avatar X
  const cam = Math.max(0, Math.min(2600, state.x - world.clientWidth*0.5));
  layers.forEach(l=>{
    const sp = parseFloat(l.dataset.speed||'0.2');
    l.style.transform = `translateX(${-cam*sp}px)`;
  });
  // Move gates and track relative to camera (they are inside world, positioned absolute by left)
  const offset = -cam; gates.forEach(g=> g.style.transform = `translateX(${offset}px)`);
  document.getElementById('track').style.transform = `translateX(${offset}px)`;

  // Avatar follows ground and stays near center
  avatar.style.left = (world.clientWidth*0.5)+'px';

  // Save position
  save(state);
}

// ===== COMPLETION
function completeLevel(i){
  if(i>state.idx) return; // locked
  if(state.completed[i]) return;
  state.completed[i] = true;
  if(state.idx < LEVELS-1) state.idx = Math.max(state.idx, i+1);
  save(state);
  render();
}

// ===== SUBMIT
function buildFormUrl(){
  const params = new URLSearchParams();
  params.set(ENTRY_MAP.level, String(state.idx+1));
  params.set(ENTRY_MAP.completed, state.completed.map(v=>v?1:0).join(','));
  const who = prompt('Enter your name or member ID (optional):', state.name || '');
  if(who!==null){ state.name = who; localStorage.setItem('fitworld.name', who); save(state); params.set(ENTRY_MAP.name, who); }
  return `${FORM_BASE}?${params.toString()}`;
}

document.getElementById('btn-submit').addEventListener('click', ()=>{ window.open(buildFormUrl(),'_blank','noopener'); });
document.getElementById('btn-reset').addEventListener('click', ()=>{ if(confirm('Reset local progress? This only affects this device.')){ state = defaultState(); save(state); render(); }});

// ===== INIT
render();
</script>
</body>
</html>
